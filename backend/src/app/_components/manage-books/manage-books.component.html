<app-navbar title="Bücher verwalten"></app-navbar>

<div class="container my-5">
    <div *ngIf="loading" class="text-center mt-5 pt-5">
        <div class="spinner spinner-border text-primary"></div>
    </div>
    <div *ngIf="!loading">
        <button class="btn btn-primary my-3" (click)="newBook()">Neues Buch</button><br>
        <small>Klicke ein Buchcover an, um weitere Optionen zu sehen. Klicke auf einen Spaltennamen, um danach zu sortieren.</small>
        <table class="table table-striped table-hover">
            <thead class="position-sticky bg-white">
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col" sortable="short" (sort)="onSort($event)">Kürzel</th>
                    <th scope="col">Cover</th>
                    <th scope="col" sortable="name" (sort)="onSort($event)">Name</th>
                    <th scope="col" sortable="publisher" (sort)="onSort($event)">Verlag</th>
                    <th scope="col" sortable="subject" (sort)="onSort($event)">Fach</th>
                    <th scope="col" sortable="language" (sort)="onSort($event)">Sprache</th>
                    <th scope="col" sortable="branch" (sort)="onSort($event)">Zweig</th>
                    <th scope="col" sortable="uebergang" (sort)="onSort($event)">Überg.</th>
                    <th scope="col" sortable="5" (sort)="onSort($event)">Jgst. 5</th>
                    <th scope="col" sortable="6" (sort)="onSort($event)">Jgst. 6</th>
                    <th scope="col" sortable="7" (sort)="onSort($event)">Jgst. 7</th>
                    <th scope="col" sortable="8" (sort)="onSort($event)">Jgst. 8</th>
                    <th scope="col" sortable="9" (sort)="onSort($event)">Jgst. 9</th>
                    <th scope="col" sortable="10" (sort)="onSort($event)">Jgst. 10</th>
                    <th scope="col" sortable="Q11" (sort)="onSort($event)">Q11</th>
                    <th scope="col" sortable="Q12" (sort)="onSort($event)">Q12</th>
                    <th>Aktionen</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let book of books">
                    <th scope="row">{{book.id}}</th>
                    <td><input class="form-control" [(ngModel)]="book.short" *ngIf="book.editing"><span *ngIf="!book.editing">{{book.short}}</span></td>
                    <td><img src="{{ apiUrl }}books/{{ book.id }}?{{coverHash}}" class="bookcover cursor-pointer" alt="Cover" (click)="openCoverModal(coverModal, book)"></td>
                    <td><input class="form-control" [(ngModel)]="book.name" *ngIf="book.editing"><span *ngIf="!book.editing">{{book.name}}</span></td>
                    <td><input class="form-control" [(ngModel)]="book.publisher" *ngIf="book.editing"><span *ngIf="!book.editing">{{book.publisher}}</span></td>
                    <td>
                        <select class="form-select" *ngIf="book.editing" [(ngModel)]="book.subject">
                            <option *ngFor="let subject of subjects" [value]="subject">{{subject}}</option>
                        </select>
                        <span *ngIf="!book.editing">{{book.subject}}</span>
                    </td>
                    <td>
                        <select class="form-select" *ngIf="book.editing" [(ngModel)]="book.language">
                            <option value="">-</option>
                            <option value="f">Franz.</option>
                            <option value="l">Latein</option>
                        </select>
                        <span *ngIf="!book.editing">{{book.language}}</span>
                    </td>
                    <td>
                        <select class="form-select" *ngIf="book.editing" [(ngModel)]="book.branch">
                            <option value="">-</option>
                            <option value="s">sprachl.</option>
                            <option value="sf">franz. Spätbeginner</option>
                            <option value="n">naturwis.</option>
                        </select>
                        <span *ngIf="!book.editing">{{book.branch}}</span>
                    </td>
                    <td>
                        <i *ngIf="!book.editing && book.uebergang == '1'" class="fas fa-check"></i>
                        <input *ngIf="book.editing" class="form-check-input" type="checkbox" [(ngModel)]="book.uebergang">
                    </td>
                    <td>
                        <i *ngIf="!book.editing && book['5'] == '1'" class="fas fa-check"></i>
                        <input *ngIf="book.editing" class="form-check-input" type="checkbox" [(ngModel)]="book['5']">
                    </td>
                    <td>
                        <i *ngIf="!book.editing && book['6'] == '1'" class="fas fa-check"></i>
                        <input *ngIf="book.editing" class="form-check-input" type="checkbox" [(ngModel)]="book['6']">
                    </td>
                    <td>
                        <i *ngIf="!book.editing && book['7'] == '1'" class="fas fa-check"></i>
                        <input *ngIf="book.editing" class="form-check-input" type="checkbox" [(ngModel)]="book['7']">
                    </td>
                    <td>
                        <i *ngIf="!book.editing && book['8'] == '1'" class="fas fa-check"></i>
                        <input *ngIf="book.editing" class="form-check-input" type="checkbox" [(ngModel)]="book['8']">
                    </td>
                    <td>
                        <i *ngIf="!book.editing && book['9'] == '1'" class="fas fa-check"></i>
                        <input *ngIf="book.editing" class="form-check-input" type="checkbox" [(ngModel)]="book['9']">
                    </td>
                    <td>
                        <i *ngIf="!book.editing && book['10'] == '1'" class="fas fa-check"></i>
                        <input *ngIf="book.editing" class="form-check-input" type="checkbox" [(ngModel)]="book['10']">
                    </td>
                    <td>
                        <i *ngIf="!book.editing && book.Q11 == '1'" class="fas fa-check"></i>
                        <input *ngIf="book.editing" class="form-check-input" type="checkbox" [(ngModel)]="book.Q11">
                    </td>
                    <td>
                        <i *ngIf="!book.editing && book.Q12 == '1'" class="fas fa-check"></i>
                        <input *ngIf="book.editing" class="form-check-input" type="checkbox" [(ngModel)]="book.Q12">
                    </td>
                    <td>
                        <button class="btn btn-outline-success" *ngIf="!book.editing && !editing" (click)="startEditing(book)"><i class="fas fa-pen"></i></button>
                        <button class="btn btn-outline-success" *ngIf="book.editing" (click)="finishEditing(book)"><i class="fas fa-save"></i></button>
                        <button class="btn btn-outline-dark" *ngIf="book.editing" (click)="cancelEditing(book)"><i class="fas fa-times"></i></button>
                        <button class="btn btn-outline-danger" *ngIf="!book.editing && !editing" (click)="removeBook(book)"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<ng-template #coverModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title" id="modal-basic-title">Buchcover</h4>
        <button type="button" class="close btn" (click)="modal.dismiss()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
        <div *ngIf="!croppingPicture">
            <img src="{{ apiUrl }}books/{{ currentBookId }}?{{coverHash}}" class="bookcover cover-big mb-4" alt="Cover"><br>
            <button class="btn btn-outline-danger me-3" (click)="removeCover()">Bild löschen</button>
            <button class="btn btn-outline-primary" (click)="selectImage()">Neues Bild hochladen</button>
        </div>
        <div *ngIf="croppingPicture">
            <div class="text-center my-5" *ngIf="!imageChangedEvent">
                <div class="spinner spinner-border text-primary"></div>
            </div>
            <div *ngIf="imageChangedEvent">
                <image-cropper [autoCrop]="true" [maintainAspectRatio]="false" (imageCropped)="onImageCropped($event)" #imageCropper [imageChangedEvent]="imageChangedEvent" format="jpeg"></image-cropper>
                <button class="btn btn-outline-success" (click)="uploadCroppedImage()">Hochladen</button>
            </div>
        </div>
    </div>
</ng-template>